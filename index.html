<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Malla Curricular Interactiva ‚Äì Ingenier√≠a Industrial UTN FRC</title>
  <style>
    /* ===== Estilos base pastel y suaves ===== */
    :root{
      --bg: #f8fafc;             /* gris azulado muy claro */
      --card: #ffffff;
      --ink: #1f2937;            /* gris oscuro */
      --muted: #6b7280;          /* gris medio */
      --accent: #93c5fd;         /* azul pastel */
      --accent-2: #a7f3d0;       /* verde menta claro */
      --pending: #e5e7eb;        /* gris claro para pendiente */
      --regular: #fde68a;        /* amarillo pastel */
      --approved: #86efac;       /* verde pastel */
      --blocked: #e2e8f0;        /* bloqueado */
      --available: #ABCFF1;      /* azul pastel (del color enviado) */
      --badge: #fbcfe8;          /* rosa muy suave */
      --shadow: 0 8px 20px rgba(2, 6, 23, 0.06);
      --radius: 16px;
    }
    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg); color: var(--ink);
    }
    header{
      position: sticky; top:0; z-index: 40;
      backdrop-filter: blur(6px);
      background: linear-gradient(to bottom, rgba(248,250,252,.9), rgba(248,250,252,.6));
      border-bottom: 1px solid #e5e7eb;
    }
    .wrap{ max-width: 1200px; margin: 0 auto; padding: 16px 20px; }
    h1{ margin:0; font-size: clamp(20px, 2vw + 8px, 28px); letter-spacing: .2px; }
    .sub{ color: var(--muted); font-size: 14px; margin-top: 6px; }

    /* ===== Panel de controles ===== */
    .controls{
      display:flex; flex-wrap: wrap; gap: 10px; margin-top: 12px;
    }
    .btn{
      border: 1px solid #e5e7eb; background: var(--card); color: var(--ink);
      padding: 10px 14px; border-radius: 12px; box-shadow: var(--shadow);
      cursor: pointer; transition: transform .06s ease, background .2s ease; font-weight:600; font-size: 14px;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.secondary{ background: #eef2ff; border-color:#e0e7ff; }
    .btn.danger{ background:#fee2e2; border-color:#fecaca; }
    .btn.icon{ display:inline-flex; align-items:center; gap:8px; }
    .spacer{ flex: 1 1 20px; }

    /* ===== Grid de a√±os/semestres ===== */
    .grid{ display:grid; grid-template-columns: repeat(6, 1fr); gap: 16px; padding: 18px 20px 40px; max-width: 1200px; margin: 0 auto; }
    .col{ background: var(--card); border: 1px solid #e5e7eb; border-radius: var(--radius); box-shadow: var(--shadow); display:flex; flex-direction: column; }
    .col h2{
      font-size: 16px; margin: 0; padding: 14px 14px; border-bottom: 1px dashed #e5e7eb; display:flex; align-items:center; justify-content: space-between; gap: 8px;
    }
    .badge{ background: var(--badge); color:#7c3aed; font-weight:700; font-size: 11px; padding: 4px 8px; border-radius: 999px; }
    .list{ padding: 10px; display:flex; flex-direction: column; gap: 10px; }

    /* ===== Tarjeta de materia ===== */
    .card{
      position: relative;
      background: var(--card);
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 10px 12px;
      display:flex; flex-direction: column; gap: 6px;
      box-shadow: var(--shadow);
      transition: filter .2s ease, transform .06s ease, background .2s ease;
      cursor: pointer;
    }
    .card:hover{ transform: translateY(-1px); }
    .title{ font-weight: 700; font-size: 14px; line-height: 1.2; }
    .meta{ display:flex; align-items:center; gap: 8px; font-size: 12px; color: var(--muted); }
    .mod{ background:#e0f2fe; color:#0369a1; padding:2px 8px; border-radius: 999px; font-weight:700; font-size: 11px; }
    .code{ background:#f1f5f9; color:#334155; padding:2px 8px; border-radius: 999px; font-weight:700; font-size: 11px; }

    /* Estados visuales */
    .state{ font-size: 11px; font-weight: 800; background:#f1f5f9; color:#334155; padding: 2px 8px; border-radius: 999px; margin-left:auto; }
    .card.pending{ background: var(--card); }
    .card.regular{ background: var(--regular); }
    .card.approved{ background: var(--approved); }
    .card.blocked{ background: var(--blocked); filter: grayscale(.3) brightness(.98); cursor: not-allowed; }
    .card.available{ outline: 2px dashed #88a9c9; background: var(--available); }

    /* Tooltip */
    .tooltip{ position: absolute; inset: auto auto 100% 0; transform: translateY(-8px); background: #0f172a; color: #fff; border-radius: 10px; padding: 10px 12px; box-shadow: var(--shadow); min-width: 220px; max-width: 320px; font-size: 12px; line-height: 1.25; display:none; }
    .tooltip::after{ content:""; position:absolute; bottom: -8px; left:12px; border-width: 8px 8px 0 8px; border-style: solid; border-color:#0f172a transparent transparent transparent; }
    .card.show-tip .tooltip{ display:block; }

    /* Responsivo */
    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 720px){ .grid{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .grid{ grid-template-columns: 1fr;} }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Malla Curricular Interactiva ‚Äì Ingenier√≠a Industrial (UTN FRC ‚Äì Plan 2023)</h1>
      <p class="sub">Haz clic en cada materia para cambiar su estado: <strong>Pendiente ‚Üí Regularizada ‚Üí Aprobada</strong>. Las materias con requisitos aparecer√°n bloqueadas hasta cumplir las correlativas. Todo se guarda en tu navegador (LocalStorage).</p>
      <div class="controls">
        <button class="btn icon" id="btnExport" title="Exportar tus estados en JSON">
          ‚Üó Exportar
        </button>
        <label class="btn icon secondary" for="importFile" title="Importar un archivo JSON con tus estados">‚¨á Importar
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </label>
        <div class="spacer"></div>
        <button class="btn danger" id="btnReset" title="Borrar todos los avances guardados">‚ü≤ Resetear todo</button>
      </div>
    </div>
  </header>

  <main class="grid" id="grid"></main>

  <!-- Di√°logo para gestionar notas -->
  <dialog id="dlgGrades">
    <form method="dialog" id="gradesForm" style="min-width:320px; max-width:520px; border:1px solid #e5e7eb; border-radius:16px; padding:16px; background:white">
      <h3 style="margin:0 0 10px 0; font-size:18px">Notas de <span id="dlgCourseTitle"></span></h3>
      <div style="display:grid; gap:12px">
        <label style="display:grid; gap:6px">
          <span style="font-size:12px; color:#6b7280">Parciales (separados por coma)</span>
          <input id="inpParciales" type="text" placeholder="ej: 7, 8, 9" style="padding:10px; border:1px solid #e5e7eb; border-radius:10px" />
        </label>
        <label style="display:grid; gap:6px">
          <span style="font-size:12px; color:#6b7280">Finales (separados por coma)</span>
          <input id="inpFinales" type="text" placeholder="ej: 6, 7" style="padding:10px; border:1px solid #e5e7eb; border-radius:10px" />
        </label>
        <div id="avgFinal" style="font-size:14px; color:#334155; background:#f1f5f9; padding:8px 10px; border-radius:10px">Promedio de finales: ‚Äì</div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px">
          <button value="cancel" class="btn" type="reset">Cancelar</button>
          <button id="btnSaveGrades" value="default" class="btn secondary" type="submit">Guardar</button>
        </div>
      </div>
    </form>
  </dialog>

  <template id="tpl-col">
    <section class="col">
      <h2><span class="h-title"></span><span class="badge"></span></h2>
      <div class="list"></div>
    </section>
  </template>

  <template id="tpl-card">
    <article class="card pending" tabindex="0" aria-live="polite">
      <div class="title"></div>
      <div class="meta">
        <span class="code"></span>
        <span class="mod" title="Modalidad">A</span>
        <span class="state">Pendiente</span>
        <button type="button" class="btn-grade" title="Cargar notas">üìù</button>
      </div>
      <div class="grades"></div>
      <div class="tooltip" role="tooltip"></div>
    </article>
  </template>

  <script>
  // ======================
  //   Datos de la Malla
  //   (Plan 2023 ‚Äì UTN FRC)
  // ======================
  // Estados: 0 = pendiente, 1 = regularizada, 2 = aprobada
  // Regla de correlativas:
  //  - Para pasar de PENDIENTE‚ÜíREGULAR: todas las "regular" requeridas deben estar >= REGULAR.
  //  - Para pasar de REGULAR‚ÜíAPROBADA: todas las "aprobada" requeridas deben estar = APROBADA.

  const COURSES = [
    // ==== 1er a√±o ====
    c(1,  "An√°lisis Matem√°tico I",                   1, "A"),
    c(2,  "Qu√≠mica General",                          1, "A"),
    c(3,  "Sistemas de Representaci√≥n",              1, "A"),
    c(4,  "Inform√°tica I",                            1, "A"),
    c(5,  "Pensamiento Sist√©mico",                   1, "A"),
    c(6,  "F√≠sica I",                                 1, "A"),
    c(7,  "√Ålgebra y Geometr√≠a Anal√≠tica",           1, "A"),
    c(8,  "Ingenier√≠a y Sociedad",                    1, "A"),

    // ==== 2do a√±o ====
    c(9,  "An√°lisis Matem√°tico II",                  2, "A",       {reg:[1,7]}),
    c(10, "Administraci√≥n General",                   2, "A",       {reg:[4,5,7,8]}),
    c(11, "Probabilidad y Estad√≠stica",               2, "A",       {reg:[1,7]}),
    c(12, "Ciencias de los Materiales",               2, "A",       {reg:[2,6]}),
    c(13, "F√≠sica II",                                2, "A",       {reg:[1,6]}),
    c(14, "Econom√≠a General",                         2, "A",       {reg:[1,5,8]}),
    c(15, "Inform√°tica II",                           2, "A",       {reg:[4]}),
    c(16, "Ingl√©s I",                                 2, "A"),

    // ==== 3er a√±o ====
    c(17, "Costos y Presupuestos",                    3, "A",       {reg:[10,14], apr:[1,4,5,7,8]}),
    c(18, "Estudio del Trabajo",                       3, "A",       {reg:[3,10,11], apr:[1,3,4,5,7,8]}),
    c(19, "Comercializaci√≥n",                         3, "A",       {reg:[10,11,14], apr:[1,4,5,7,8]}),
    c(20, "Termodin√°mica y M√°quinas T√©rmicas",        3, "A",       {reg:[2,13], apr:[1,6]}),
    c(21, "Est√°tica y Resistencia de los Materiales", 3, "A",       {reg:[9,12], apr:[1,2,6,7]}),
    c(22, "Mec√°nica de los Fluidos",                  3, "A",       {reg:[9], apr:[1,6,7]}),
    c(23, "Econom√≠a de la Empresa",                    3, "A",       {reg:[10,14], apr:[1,4,5,7,8]}),
    c(24, "Electrotecnia y M√°quinas El√©ctricas",      3, "A",       {reg:[13], apr:[1,6]}),
    c(25, "An√°lisis Num√©rico y C√°lculo Avanzado",     3, "A",       {reg:[9], apr:[1,7]}),

    // ==== 4to a√±o ====
    c(26, "Seguridad, Higiene e Ing. Ambiental",      4, "A",       {reg:[18], apr:[10,11]}),
    c(27, "Investigaci√≥n Operativa",                  4, "A",       {reg:[9,11,25], apr:[1,7,25]}),
    c(28, "Procesos Industriales",                     4, "A",       {reg:[18,20,24], apr:[2,10,12,13]}),
    c(29, "Mec√°nica y Mecanismos",                     4, "A",       {reg:[9], apr:[1,6,7]}),
    c(30, "Evaluaci√≥n de Proyectos",                   4, "A",       {reg:[17,18,19,23], apr:[10,11,14,16]}),
    c(31, "Planificaci√≥n y Control de la Producci√≥n",  4, "A",       {reg:[18], apr:[10,11]}),
    c(32, "Dise√±o de Producto",                        4, "A",       {reg:[15,19], apr:[3,4,10,11,14]}),
    c(33, "Ingl√©s II",                                 4, "A",       {reg:[16]}),
    c(34, "Instalaciones Industriales",                4, "A",       {reg:[20,21,22,24], apr:[2,9,12,13]}),
    c(35, "Legislaci√≥n",                               4, "A",       {apr:[10]}),

    // ==== 5to a√±o ====
    c(36, "Mantenimiento",                             5, "A",       {reg:[34], apr:[20,21,24]}),
    c(37, "Manejo de Materiales y Distribuci√≥n de Planta",5, "A",   {reg:[18,29], apr:[9,10,21]}),
    c(38, "Comercio Exterior",                          5, "A",      {reg:[30], apr:[18,19,23]}),
    c(39, "Relaciones Industriales",                    5, "A",      {reg:[18], apr:[10,11]}),
    c(40, "Ingenier√≠a en Calidad",                      5, "A",      {reg:[18], apr:[10,11]}),
    c(41, "Control de Gesti√≥n",                         5, "A",      {reg:[17,23], apr:[10,14]}),
    c(42, "Proyecto Final",                             5, "A",      {reg:[25,26,27,28,30,31], apr:[18,19,20,21,22,23,24,33]}),
  ];

  // Electivas (se muestran en una columna aparte). Se usan c√≥digos desde 101 en adelante para no colisionar.
  const ELECTIVES = [
    e(101, "Gesti√≥n Ambiental (Electiva)",                         {reg:[26]}),
    e(102, "Gesti√≥n de Proyectos (Electiva)",                      {reg:[27,31,32], apr:[10,14,17,18]}),
    e(103, "Gesti√≥n Emprendedora (Electiva)",                      {reg:[30,31], apr:[10,17,19,23]}),
    e(104, "Log√≠stica (Electiva)",                                  {reg:[27,30,31], apr:[18,23]}),
    e(105, "Pol√≠tica Econ√≥mica (Electiva)",                         {reg:[30], apr:[19,23]}),
    e(106, "Energ√≠as Renovables (Electiva)",                        {reg:[20,24,26,28,32], apr:[2]}),
    e(107, "Gesti√≥n del Conocimiento e Innovaci√≥n (Electiva)",      {reg:[18,27], apr:[10,25]}),
    e(108, "Coaching de Formadores (Electiva)",                     {reg:[17,18,19], apr:[10,14]}),
    e(109, "Simulaci√≥n (Electiva)",                                  {reg:[27,30,31,32], apr:[18]}),
    e(110, "An√°lisis de Datos I (Electiva)",                         {reg:[25,27], apr:[10,11,14,15,33]}),
    e(111, "Sustentabilidad y Nuevas Econom√≠as (Electiva)",         {reg:[17,18,19,30], apr:[10,14]}),
    e(112, "CNH C√°tedra IN STU (Electiva)",                         {reg:[31,32,27], apr:[10,14,17,18,19]}),
  ];

  function c(code, name, year, mod, req={}){
    return { code, name, year, mod, reg:req.reg||[], apr:req.apr||[], elective:false };
  }
  function e(code, name, req={}){
    return { code, name, year: 6, mod: "1C/2C", reg:req.reg||[], apr:req.apr||[], elective:true };
  }

  // ============ Utilidades de almacenamiento ============
  const LS_KEY = 'utn-frc-industrial-plan-2023';
  const LS_GRADES = 'utn-frc-industrial-grades';
  let state = loadState(); // { [code]: 0|1|2 }
  let grades = loadGrades(); // { [code]: { parciales:number[], finales:number[] } }

  function loadState(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {}; }catch{ return {}; }
  }
  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function loadGrades(){ try{ return JSON.parse(localStorage.getItem(LS_GRADES)) || {}; }catch{ return {}; } }
  function saveGrades(){ localStorage.setItem(LS_GRADES, JSON.stringify(grades)); }

  // ============ Render del grid ============
  const grid = document.getElementById('grid');
  const columns = [
    { title: '1¬∫ A√±o', year:1, badge:'Anual (A)' },
    { title: '2¬∫ A√±o', year:2, badge:'Anual (A)' },
    { title: '3¬∫ A√±o', year:3, badge:'Anual (A)' },
    { title: '4¬∫ A√±o', year:4, badge:'Anual (A / 1C-2C)' },
    { title: '5¬∫ A√±o', year:5, badge:'Anual (A / 1C-2C)' },
    { title: 'Electivas', year:6, badge:'1C / 2C' },
  ];

  function render(){
    grid.innerHTML = '';
    const tplCol = document.getElementById('tpl-col');
    const tplCard = document.getElementById('tpl-card');

    for(const col of columns){
      const node = tplCol.content.cloneNode(true);
      node.querySelector('.h-title').textContent = col.title;
      node.querySelector('.badge').textContent = col.badge;
      const list = node.querySelector('.list');

      const items = (col.year===6 ? ELECTIVES : COURSES.filter(x=>x.year===col.year));
      items.forEach(item => list.appendChild(buildCard(tplCard, item)) );

      grid.appendChild(node);
    }
  }

  function buildCard(tplCard, item){
    const el = tplCard.content.cloneNode(true).children[0];
    el.dataset.code = item.code;
    el.querySelector('.title').textContent = item.name;
    el.querySelector('.code').textContent = `#${item.code}`;
    el.querySelector('.mod').textContent = item.mod || 'A';

    applyVisualState(el, getState(item.code));
    updateBlocked(el, item);
    renderGradesOnCard(el, item.code);

    el.addEventListener('click', (ev)=>{
      if(ev.target && ev.target.classList.contains('btn-grade')) return; // el bot√≥n abre di√°logo
      if(el.classList.contains('blocked')){ toggleTip(el, true); return; }
      const current = getState(item.code);
      const next = (current + 1) % 3; // 0->1->2->0

      if(current === 0 && next === 1){
        const missingReg = missingForRegular(item);
        if(missingReg.length){ return showBlocked(el, item, missingReg, []); }
      }
      if(current === 1 && next === 2){
        const missingApr = missingForApproved(item);
        if(missingApr.length){ return showBlocked(el, item, [], missingApr); }
      }
      setState(item.code, next);
      refreshAll();
    });

    // bot√≥n de notas
    el.querySelector('.btn-grade').addEventListener('click', (ev)=>{
      ev.stopPropagation();
      openGradesDialog(item.code, item.name);
    });

    el.addEventListener('mouseenter', ()=>{ if(el.classList.contains('blocked')) toggleTip(el, true); });
    el.addEventListener('mouseleave', ()=>toggleTip(el,false));
    el.addEventListener('blur', ()=>toggleTip(el,false));

    return el;
  }

  function getState(code){ return state[code] ?? 0; }
  function setState(code, val){ state[code] = val; saveState(); }

  function applyVisualState(card, s){
    card.classList.remove('pending','regular','approved');
    let label = 'Pendiente';
    if(s===1){ card.classList.add('regular'); label = 'Regularizada'; }
    else if(s===2){ card.classList.add('approved'); label = 'Aprobada'; }
    else { card.classList.add('pending'); }
    card.querySelector('.state').textContent = label;
  }

  function courseByCode(code){
    return COURSES.find(x=>x.code===code) || ELECTIVES.find(x=>x.code===code);
  }

  function missingForRegular(item){
    return (item.reg||[]).filter(code => getState(code) < 1);
  }
  function missingForApproved(item){
    return (item.apr||[]).filter(code => getState(code) < 2);
  }

  function reasonText(item, missReg, missApr){
    const fmt = codes => codes.map(c=>`#${c} ‚Äì ${courseByCode(c)?.name||'¬ø?'} (${stateLabel(getState(c))})`).join('\n');
    const lines = [];
    if(missReg.length){ lines.push('Para REGULARIZAR necesitas:\n' + fmt(missReg)); }
    if(missApr.length){ lines.push('Para APROBAR necesitas:\n' + fmt(missApr)); }
    return lines.join('\n\n');
  }
  function stateLabel(s){ return s===2?'Aprobada':(s===1?'Regularizada':'Pendiente'); }

  function updateBlocked(card, item){
    const s = getState(item.code);
    let blocked=false, tip='';
    if(s===0){
      const miss = missingForRegular(item);
      blocked = miss.length>0;
      tip = reasonText(item, miss, []);
    } else if(s===1){
      const miss = missingForApproved(item);
      blocked = miss.length>0;
      tip = reasonText(item, [], miss);
    }
    card.classList.toggle('blocked', blocked);
    // Disponible para cursar: pendiente y sin requisitos faltantes
    const available = !blocked && s===0;
    card.classList.toggle('available', available);

    const tipEl = card.querySelector('.tooltip');
    tipEl.textContent = blocked ? tip : '';
    card.title = blocked ? tip.replaceAll('
',' ‚Ä¢ ') : '';
  }

  function showBlocked(card, item, missReg, missApr){
    const tipEl = card.querySelector('.tooltip');
    tipEl.textContent = reasonText(item, missReg, missApr);
    card.classList.add('blocked');
    toggleTip(card,true);
  }
  function toggleTip(card, show){ card.classList.toggle('show-tip', !!show); }

  function refreshAll(){
    document.querySelectorAll('.card').forEach(card=>{
      const code = +card.dataset.code;
      applyVisualState(card, getState(code));
      updateBlocked(card, courseByCode(code));
      renderGradesOnCard(card, code);
    });
  }

  // ==== Gesti√≥n de notas ====
  function getGrades(code){ return grades[code] || { parciales:[], finales:[] }; }
  function setGrades(code, g){ grades[code] = g; saveGrades(); }
  function parseNums(str){
    if(!str) return [];
    return str.split(',').map(s=>parseFloat(s.trim().replace(',', '.'))).filter(n=>!isNaN(n));
  }
  function avg(arr){ if(!arr.length) return null; const s = arr.reduce((a,b)=>a+b,0); return +(s/arr.length).toFixed(2); }

  const dlg = document.getElementById('dlgGrades');
  const form = document.getElementById('gradesForm');
  const inpP = document.getElementById('inpParciales');
  const inpF = document.getElementById('inpFinales');
  const avgBox = document.getElementById('avgFinal');
  const titleSpan = document.getElementById('dlgCourseTitle');
  let currentCourseCode = null;

  function openGradesDialog(code, name){
    currentCourseCode = code;
    titleSpan.textContent = `#${code} ‚Äì ${name}`;
    const g = getGrades(code);
    inpP.value = g.parciales.join(', ');
    inpF.value = g.finales.join(', ');
    updateAvgPreview();
    dlg.showModal();
  }

  function updateAvgPreview(){
    const finals = parseNums(inpF.value);
    const m = avg(finals);
    avgBox.textContent = 'Promedio de finales: ' + (m==null? '‚Äì' : m);
  }
  inpF.addEventListener('input', updateAvgPreview);

  form.addEventListener('submit', (ev)=>{
    ev.preventDefault();
    const g = {
      parciales: parseNums(inpP.value),
      finales: parseNums(inpF.value),
    };
    setGrades(currentCourseCode, g);
    dlg.close();
    refreshAll();
  });

  // Render de mini badges de notas
  function renderGradesOnCard(card, code){
    const g = getGrades(code);
    const avgF = avg(g.finales);
    const box = card.querySelector('.grades');
    const pill = (label,val)=>`<span style="display:inline-block;background:#f1f5f9;color:#334155;border-radius:999px;padding:2px 8px;font-size:11px;font-weight:700">${label}: ${val}</span>`;
    const pills = [];
    if(g.parciales.length) pills.push(pill('Parciales', g.parciales.join('¬∑')));
    if(g.finales.length) pills.push(pill('Finales', g.finales.join('¬∑')));
    if(avgF!=null) pills.push(pill('Prom. Finales', avgF));
    box.innerHTML = pills.join(' ');
  }

  // ============ Exportar / Importar / Reset ============
  document.getElementById('btnExport').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify({state, grades}, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'malla-utn-frc-industrial-estado.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  });

  document.getElementById('importFile').addEventListener('change', (ev)=>{
    const file = ev.target.files?.[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = JSON.parse(String(reader.result));
        if(typeof data === 'object' && data){
          if(data.state){ state = data.state; saveState(); }
          if(data.grades){ grades = data.grades; saveGrades(); }
          // Compatibilidad con exportaciones antiguas
          if(!data.state && !data.grades){ state = data; saveState(); }
          refreshAll();
        }
      }catch(e){ alert('Archivo inv√°lido. Debe ser JSON exportado desde esta malla.'); }
    };
    reader.readAsText(file);
  });

  document.getElementById('btnReset').addEventListener('click', ()=>{
    if(confirm('¬øSeguro que deseas borrar todo tu progreso?')){
      state = {}; grades = {}; saveState(); saveGrades(); refreshAll();
    }
  });

  // Inicializar
  render();

  </script>
</body>
</html>
