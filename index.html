<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Malla Ingenier√≠a Industrial - UTN FRC</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    background: #f8fafc;
    color: #1f2937;
  }
  header {
    background: #e0f2fe;
    text-align: center;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,.1);
  }
  h1 { margin: 0; }
  main {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
    gap: 12px;
    padding: 20px;
  }
  .col {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,.1);
    padding: 10px;
  }
  .col h2 {
    margin-top: 0;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 6px;
    text-align: center;
  }
  .materia {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 8px;
    margin: 6px 0;
    cursor: pointer;
    position: relative;
    transition: 0.2s;
  }
  .materia.regular { background: #fde68a; }
  .materia.aprobada { background: #86efac; }
  .materia.bloqueada { background: #e2e8f0; color: #9ca3af; cursor: not-allowed; }
  .materia.disponible { background: #ABCFF1; }
  .tooltip {
    display: none;
    position: absolute;
    background: #111827;
    color: white;
    padding: 6px 10px;
    border-radius: 8px;
    top: -5px;
    left: 100%;
    margin-left: 8px;
    font-size: 12px;
    width: 200px;
    z-index: 10;
  }
  .materia:hover .tooltip { display: block; }
  button {
    cursor: pointer;
  }
  .btn-nota {
    float: right;
    background: #93c5fd;
    border: none;
    border-radius: 6px;
    padding: 2px 6px;
  }
  dialog {
    border: none;
    border-radius: 10px;
    padding: 20px;
    max-width: 300px;
  }
  input {
    width: 100%;
    padding: 6px;
    margin-top: 4px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
  }
</style>
</head>
<body>
<header>
  <h1>Malla Ingenier√≠a Industrial - UTN FRC</h1>
  <p>Click en cada materia para cambiar su estado. üìù para cargar notas.</p>
</header>

<main id="malla"></main>

<dialog id="dlgNotas">
  <form method="dialog" id="formNotas">
    <h3 id="dlgTitulo"></h3>
    <label>Parciales:<br><input id="inParciales" placeholder="7, 8, 9"></label><br>
    <label>Finales:<br><input id="inFinales" placeholder="6, 8"></label><br>
    <p id="promedio">Promedio de finales: ‚Äì</p>
    <menu>
      <button value="cancel">Cancelar</button>
      <button id="btnGuardar" value="default">Guardar</button>
    </menu>
  </form>
</dialog>

<script>
// ======== Datos ========
const materias = [
  {id:1, nombre:"An√°lisis Matem√°tico I", anio:1, reg:[], apr:[]},
  {id:2, nombre:"F√≠sica I", anio:1, reg:[], apr:[]},
  {id:3, nombre:"Qu√≠mica General", anio:1, reg:[], apr:[]},
  {id:4, nombre:"An√°lisis Matem√°tico II", anio:2, reg:[1], apr:[1]},
  {id:5, nombre:"F√≠sica II", anio:2, reg:[2], apr:[2]},
  {id:6, nombre:"Termodin√°mica", anio:3, reg:[5], apr:[5]}
];

let estado = JSON.parse(localStorage.getItem("estadoMalla")||"{}");
let notas = JSON.parse(localStorage.getItem("notasMalla")||"{}");

// ======== Render ========
const malla = document.getElementById("malla");

function render() {
  malla.innerHTML = "";
  for(let anio=1; anio<=3; anio++){
    const col = document.createElement("div");
    col.className="col";
    col.innerHTML=`<h2>${anio}¬∞ A√±o</h2>`;
    materias.filter(m=>m.anio===anio).forEach(m=>{
      const div=document.createElement("div");
      div.className="materia";
      div.dataset.id=m.id;
      const st=estado[m.id]||0;
      if(st===1) div.classList.add("regular");
      if(st===2) div.classList.add("aprobada");
      // correlativas
      const bloqueada = m.reg.some(r=>!estado[r]) || m.apr.some(r=>estado[r]<2);
      if(bloqueada && st===0){
        div.classList.add("bloqueada");
        div.innerHTML=`${m.nombre}<div class="tooltip">Faltan correlativas</div>`;
      } else if(!bloqueada && st===0) {
        div.classList.add("disponible");
        div.innerHTML=`${m.nombre}`;
      } else {
        div.innerHTML=`${m.nombre}`;
      }
      // Bot√≥n de notas
      const btn=document.createElement("button");
      btn.textContent="üìù";
      btn.className="btn-nota";
      btn.onclick=e=>{
        e.stopPropagation();
        abrirNotas(m);
      };
      div.appendChild(btn);

      // click cambia estado
      div.onclick=()=>{
        if(div.classList.contains("bloqueada"))return;
        const cur=estado[m.id]||0;
        estado[m.id]=(cur+1)%3;
        guardar();
        render();
      };
      // mostrar resumen de notas
      if(notas[m.id]){
        const nf=notas[m.id];
        const prom = promedio(nf.finales);
        if(prom) div.innerHTML += `<br><small>Prom: ${prom}</small>`;
      }
      col.appendChild(div);
    });
    malla.appendChild(col);
  }
}

function guardar(){
  localStorage.setItem("estadoMalla", JSON.stringify(estado));
  localStorage.setItem("notasMalla", JSON.stringify(notas));
}

// ======== Notas ========
const dlg=document.getElementById("dlgNotas");
const inP=document.getElementById("inParciales");
const inF=document.getElementById("inFinales");
const prom=document.getElementById("promedio");
const titulo=document.getElementById("dlgTitulo");
let actual=0;

function abrirNotas(m){
  actual=m.id;
  titulo.textContent=m.nombre;
  const n=notas[m.id]||{parciales:[], finales:[]};
  inP.value=n.parciales.join(", ");
  inF.value=n.finales.join(", ");
  prom.textContent="Promedio de finales: "+(promedio(n.finales)||"‚Äì");
  dlg.showModal();
}

function promedio(arr){
  if(!arr||arr.length===0)return null;
  const s=arr.reduce((a,b)=>a+b,0);
  return (s/arr.length).toFixed(2);
}

inF.oninput=()=>{
  const nums=parse(inF.value);
  prom.textContent="Promedio de finales: "+(promedio(nums)||"‚Äì");
};

function parse(t){
  return t.split(",").map(x=>parseFloat(x)).filter(x=>!isNaN(x));
}

document.getElementById("formNotas").onsubmit=e=>{
  e.preventDefault();
  notas[actual]={parciales:parse(inP.value), finales:parse(inF.value)};
  guardar();
  dlg.close();
  render();
};

// ======== Inicial ========
render();
</script>
</body>
</html>
