<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Malla Interactiva Ingenier√≠a Industrial ‚Äì UTN FRC</title>
<style>
  /* =========================
     Paleta y temas (claro/oscuro)
     ========================= */
  :root{
    --bg: #F6F4FF;                /* fondo pastel */
    --ink: #1f2937;
    --muted: #6b7280;
    --card: #ffffff;
    --border: #e5e7eb;
    --shadow: 0 8px 20px rgba(2, 6, 23, 0.06);
    --radius: 16px;

    --available: #A7D8FF;         /* celeste pastel (disponible) */
    --inprogress: #E0E7FF;        /* violeta pastel (en curso) */
    --regular: #fde68a;           /* amarillo pastel (regularizada) */
    --approved: #86efac;          /* verde pastel (aprobada) */
    --blocked: #e2e8f0;           /* gris bloqueada */
    --badge: #fbcfe8;

    --header-grad-start: #DDE9FF;
    --header-grad-end:   #E7DFFF;
    --button: #eef2ff;
    --button-border: #e0e7ff;
  }
  :root[data-theme="dark"]{
    --bg: #0f172a;
    --ink: #e5e7eb;
    --muted: #94a3b8;
    --card: #111827;
    --border: #1f2937;
    --shadow: 0 8px 24px rgba(0,0,0,.45);

    --available: #3b82f640;
    --inprogress: #6366f140;
    --regular: #ca8a0426;
    --approved: #16a34a26;
    --blocked: #1f2937;
    --badge: #7c3aed26;

    --header-grad-start: #111827;
    --header-grad-end:   #0b1220;
    --button: #0b1220;
    --button-border: #1f2937;
  }

  *{ box-sizing: border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans";
    background: var(--bg);
    color: var(--ink);
    overflow-x: hidden;
  }

  /* =========================
     Barra fija superior
     ========================= */
  header.statsbar{
    position: sticky; top:0; z-index: 50;
    background: linear-gradient(90deg, var(--header-grad-start), var(--header-grad-end));
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(6px);
    box-shadow: var(--shadow);
  }
  .wrap{ max-width: 1600px; margin: 0 auto; padding: 10px 12px; }
  .stats{
    display:flex; align-items:center; justify-content:center; gap: 12px;
    text-align:center; line-height:1.35; flex-wrap:wrap;
  }
  .stats .row{ width:100%; display:flex; align-items:center; justify-content:center; gap:12px; }
  .pill{
    background: rgba(255,255,255,.6);
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 6px 12px;
    font-weight: 700;
    color: #111827;
  }
  :root[data-theme="dark"] .pill{
    background: rgba(30,41,59,.6);
    color: #e5e7eb;
  }
  .toggle{
    position: absolute; right: 12px; top: 10px;
    display:flex; align-items:center; gap:8px;
  }
  .btn{
    border: 1px solid var(--button-border);
    background: var(--button);
    color: var(--ink);
    padding: 8px 10px;
    border-radius: 999px;
    cursor: pointer;
    font-weight: 700;
    transition: transform .06s ease, background .2s ease;
  }
  .btn:hover{ transform: translateY(-1px); }

  /* =========================
     Panel de controles
     ========================= */
  .controls{
    max-width: 1600px; margin: 10px auto 0; padding: 0 12px 10px;
    display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
  }
  .btn.secondary{ background: #eef2ff; border-color:#e0e7ff; }
  :root[data-theme="dark"] .btn.secondary{ background:#0b1220; border-color:#1f2937; }
  .btn.danger{ background:#fee2e2; border-color:#fecaca; }

  /* =========================
     Grid: sin ‚Äúhueco‚Äù a la izquierda
     ========================= */
  main.grid{
    display:grid;
    grid-template-columns: repeat(6, minmax(220px, 1fr));
    gap: 14px;
    padding: 16px 12px 40px;
    max-width: 1600px;
    margin: 0 auto;       /* centrado sim√©trico */
    width: 100%;
  }
  @media (max-width: 1400px){ main.grid{ grid-template-columns: repeat(5, minmax(220px, 1fr)); } }
  @media (max-width: 1200px){ main.grid{ grid-template-columns: repeat(4, minmax(220px, 1fr)); } }
  @media (max-width: 900px){  main.grid{ grid-template-columns: repeat(2, minmax(220px, 1fr)); } }
  @media (max-width: 520px){  main.grid{ grid-template-columns: 1fr; } }

  .col{ background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); display:flex; flex-direction: column; }
  .col h2{
    font-size: 16px; margin: 0; padding: 12px 14px; border-bottom: 1px dashed var(--border);
    display:flex; align-items:center; justify-content: space-between; gap: 8px;
  }
  .year-averages{ color: var(--muted); font-size: 12px; font-weight: 700; }
  .badge{ background: var(--badge); color:#7c3aed; font-weight:700; font-size: 11px; padding: 4px 8px; border-radius: 999px; }
  :root[data-theme="dark"] .badge{ color:#c4b5fd; }
  .list{ padding: 10px; display:flex; flex-direction: column; gap: 10px; }

  /* =========================
     Tarjeta de materia
     ========================= */
  .card{
    position: relative;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 10px 12px;
    display:flex; flex-direction: column; gap: 6px;
    box-shadow: var(--shadow);
    transition: filter .2s ease, transform .06s ease, background .2s ease;
    cursor: pointer;
  }
  .card:hover{ transform: translateY(-1px); }
  .title{ font-weight: 800; font-size: 14px; line-height: 1.25; }
  .meta{ display:flex; align-items:center; gap: 8px; font-size: 12px; color: var(--muted); }
  .mod{ background:#e0f2fe; color:#0369a1; padding:2px 8px; border-radius: 999px; font-weight:700; font-size: 11px; }
  :root[data-theme="dark"] .mod{ background:#0b1220; color:#7dd3fc; border: 1px solid var(--border); }
  .code{ background:#f1f5f9; color:#334155; padding:2px 8px; border-radius: 999px; font-weight:700; font-size: 11px; }
  :root[data-theme="dark"] .code{ background:#0b1220; color:#cbd5e1; border: 1px solid var(--border); }

  /* Estados visuales */
  .state{ font-size: 11px; font-weight: 800; background:#f1f5f9; color:#334155; padding: 2px 8px; border-radius: 999px; margin-left:auto; }
  :root[data-theme="dark"] .state{ background:#0b1220; color:#cbd5e1; border:1px solid var(--border); }

  .card.pending{ background: var(--card); }
  .card.inprogress{ background: var(--inprogress); }
  .card.regular{ background: var(--regular); }
  .card.approved{ background: var(--approved); }
  .card.blocked{ background: var(--blocked); filter: grayscale(.2) brightness(1); cursor: not-allowed; }
  .card.available{ outline: 2px dashed rgba(136,169,201,.8); background: var(--available); }

  /* L√≠nea de promedios por tarjeta */
  .gradesline{ font-size: 12px; color: var(--muted); display:flex; gap:12px; flex-wrap:wrap; }

  /* Tooltip */
  .tooltip{ position: absolute; inset: auto auto 100% 0; transform: translateY(-8px); background: #0f172a; color: #fff; border-radius: 10px; padding: 10px 12px; box-shadow: var(--shadow); min-width: 220px; max-width: 320px; font-size: 12px; line-height: 1.25; display:none; }
  .tooltip::after{ content:""; position:absolute; bottom: -8px; left:12px; border-width: 8px 8px 0 8px; border-style: solid; border-color:#0f172a transparent transparent transparent; }
  .card.show-tip .tooltip{ display:block; }

  /* Di√°logo de notas */
  dialog#dlgNotas{
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 16px;
    background: var(--card);
    color: var(--ink);
    max-width: 460px;
    width: 96%;
  }
  .dlg-grid{ display:grid; gap:10px; }
  .form-row{ display:grid; gap:6px; }
  .form-row input, .form-row select{
    background: var(--card);
    color: var(--ink);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px 10px;
  }
  .inputs-parciales{ display:grid; gap:8px; grid-template-columns: repeat(2, 1fr); }
  .dlg-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:6px; }

  /* Confetti canvas */
  #confettiCanvas{
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 100;
  }
</style>
</head>
<body>
  <!-- Canvas para confetti -->
  <canvas id="confettiCanvas"></canvas>

  <!-- Barra fija con estad√≠sticas -->
  <header class="statsbar">
    <div class="wrap">
      <div class="toggle">
        <button id="btnTheme" class="btn" title="Cambiar modo claro/oscuro">üåó Modo</button>
      </div>
      <div class="stats" id="statsBar">
        <div class="row">
          <span class="pill" id="pillReg">Regularizadas: 0 (0%)</span>
          <span class="pill" id="pillApr">Aprobadas: 0 (0%)</span>
        </div>
        <div class="row">
          <span class="pill" id="pillPromParc">Promedio Parciales: ‚Äì</span>
          <span class="pill" id="pillPromFinal">Promedio Finales: ‚Äì</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Controles generales -->
  <div class="controls">
    <button class="btn" id="btnExport" title="Exportar progreso a JSON">‚Üó Exportar</button>
    <label class="btn secondary" for="importFile" title="Importar progreso desde JSON">‚¨á Importar
      <input id="importFile" type="file" accept="application/json" style="display:none" />
    </label>
    <button class="btn danger" id="btnReset" title="Borrar todo el progreso">‚ü≤ Resetear</button>
  </div>

  <!-- Grid -->
  <main class="grid" id="grid"></main>

  <!-- Templates -->
  <template id="tpl-col">
    <section class="col">
      <h2>
        <span class="h-title"></span>
        <span class="year-averages"></span>
        <span class="badge"></span>
      </h2>
      <div class="list"></div>
    </section>
  </template>

  <template id="tpl-card">
    <article class="card pending" tabindex="0" aria-live="polite">
      <div class="title"></div>
      <div class="meta">
        <span class="code"></span>
        <span class="mod" title="Modalidad">A</span>
        <span class="state">Pendiente</span>
        <button type="button" class="btn" style="margin-left:auto" data-role="notas">üìù Notas</button>
      </div>
      <div class="gradesline" aria-label="Promedios de la materia"></div>
      <div class="tooltip" role="tooltip"></div>
    </article>
  </template>

  <!-- Di√°logo de Notas -->
  <dialog id="dlgNotas">
    <form method="dialog" id="formNotas" class="dlg-grid">
      <h3 id="dlgTitulo" style="margin:0 0 6px 0">Notas</h3>
      <div class="form-row">
        <label for="selCantidad">Cantidad de parciales</label>
        <select id="selCantidad">
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
        </select>
      </div>
      <div class="form-row">
        <label>Notas de parciales</label>
        <div id="inputsParciales" class="inputs-parciales"></div>
      </div>
      <div class="form-row">
        <label for="inpFinal">Nota de final</label>
        <input type="number" id="inpFinal" min="0" max="10" step="0.01" placeholder="Ej: 7.50" />
      </div>
      <div class="form-row" style="color:var(--muted); font-weight:700">
        <div id="prevPromParc">Prom. parciales: ‚Äì</div>
        <div id="prevPromFinal">Prom. final(es): ‚Äì</div>
      </div>
      <div class="dlg-actions">
        <button class="btn" value="cancel" type="reset">Cancelar</button>
        <button id="btnGuardarNotas" class="btn secondary" value="default" type="submit">Guardar</button>
      </div>
    </form>
  </dialog>

<script>
/* ======================
   Datos de la Malla (Plan de ejemplo ‚Äì ajustable)
   ====================== */
function c(code, name, year, mod, req={}){ return { code, name, year, mod, reg:req.reg||[], apr:req.apr||[], elective:false }; }
function e(code, name, req={}){ return { code, name, year: 6, mod: "1C/2C", reg:req.reg||[], apr:req.apr||[], elective:true }; }

const COURSES = [
  // 1er a√±o
  c(1,  "An√°lisis Matem√°tico I",                   1, "A"),
  c(2,  "Qu√≠mica General",                         1, "A"),
  c(3,  "Sistemas de Representaci√≥n",              1, "A"),
  c(4,  "Inform√°tica I",                           1, "A"),
  c(5,  "Pensamiento Sist√©mico",                   1, "A"),
  c(6,  "F√≠sica I",                                1, "A"),
  c(7,  "√Ålgebra y Geometr√≠a Anal√≠tica",          1, "A"),
  c(8,  "Ingenier√≠a y Sociedad",                   1, "A"),

  // 2do a√±o
  c(9,  "An√°lisis Matem√°tico II",                  2, "A", {reg:[1,7]}),
  c(10, "Administraci√≥n General",                  2, "A", {reg:[4,5,7,8]}),
  c(11, "Probabilidad y Estad√≠stica",              2, "A", {reg:[1,7]}),
  c(12, "Ciencias de los Materiales",              2, "A", {reg:[2,6]}),
  c(13, "F√≠sica II",                               2, "A", {reg:[1,6]}),
  c(14, "Econom√≠a General",                        2, "A", {reg:[1,5,8]}),
  c(15, "Inform√°tica II",                          2, "A", {reg:[4]}),
  c(16, "Ingl√©s I",                                2, "A"),

  // 3er a√±o
  c(17, "Costos y Presupuestos",                   3, "A", {reg:[10,14], apr:[1,4,5,7,8]}),
  c(18, "Estudio del Trabajo",                     3, "A", {reg:[3,10,11], apr:[1,3,4,5,7,8]}),
  c(19, "Comercializaci√≥n",                        3, "A", {reg:[10,11,14], apr:[1,4,5,7,8]}),
  c(20, "Termodin√°mica y M√°quinas T√©rmicas",       3, "A", {reg:[2,13], apr:[1,6]}),
  c(21, "Est√°tica y Resistencia de los Materiales",3, "A", {reg:[9,12], apr:[1,2,6,7]}),
  c(22, "Mec√°nica de los Fluidos",                 3, "A", {reg:[9], apr:[1,6,7]}),
  c(23, "Econom√≠a de la Empresa",                  3, "A", {reg:[10,14], apr:[1,4,5,7,8]}),
  c(24, "Electrotecnia y M√°quinas El√©ctricas",     3, "A", {reg:[13], apr:[1,6]}),
  c(25, "An√°lisis Num√©rico y C√°lculo Avanzado",    3, "A", {reg:[9], apr:[1,7]}),

  // 4to a√±o
  c(26, "Seguridad, Higiene e Ing. Ambiental",     4, "A", {reg:[18], apr:[10,11]}),
  c(27, "Investigaci√≥n Operativa",                 4, "A", {reg:[9,11,25], apr:[1,7,25]}),
  c(28, "Procesos Industriales",                   4, "A", {reg:[18,20,24], apr:[2,10,12,13]}),
  c(29, "Mec√°nica y Mecanismos",                   4, "A", {reg:[9], apr:[1,6,7]}),
  c(30, "Evaluaci√≥n de Proyectos",                 4, "A", {reg:[17,18,19,23], apr:[10,11,14,16]}),
  c(31, "Planificaci√≥n y Control de la Producci√≥n",4, "A", {reg:[18], apr:[10,11]}),
  c(32, "Dise√±o de Producto",                      4, "A", {reg:[15,19], apr:[3,4,10,11,14]}),
  c(33, "Ingl√©s II",                               4, "A", {reg:[16]}),
  c(34, "Instalaciones Industriales",              4, "A", {reg:[20,21,22,24], apr:[2,9,12,13]}),
  c(35, "Legislaci√≥n",                             4, "A", {apr:[10]}),

  // 5to a√±o
  c(36, "Mantenimiento",                            5, "A", {reg:[34], apr:[20,21,24]}),
  c(37, "Manejo de Materiales y Distribuci√≥n de Planta",5,"A",{reg:[18,29], apr:[9,10,21]}),
  c(38, "Comercio Exterior",                        5, "A", {reg:[30], apr:[18,19,23]}),
  c(39, "Relaciones Industriales",                  5, "A", {reg:[18], apr:[10,11]}),
  c(40, "Ingenier√≠a en Calidad",                    5, "A", {reg:[18], apr:[10,11]}),
  c(41, "Control de Gesti√≥n",                       5, "A", {reg:[17,23], apr:[10,14]}),
  c(42, "Proyecto Final",                           5, "A", {reg:[25,26,27,28,30,31], apr:[18,19,20,21,22,23,24,33]}),
];

const ELECTIVES = [
  e(101, "Gesti√≥n Ambiental (Electiva)",                         {reg:[26]}),
  e(102, "Gesti√≥n de Proyectos (Electiva)",                      {reg:[27,31,32], apr:[10,14,17,18]}),
  e(103, "Gesti√≥n Emprendedora (Electiva)",                      {reg:[30,31], apr:[10,17,19,23]}),
  e(104, "Log√≠stica (Electiva)",                                  {reg:[27,30,31], apr:[18,23]}),
  e(105, "Pol√≠tica Econ√≥mica (Electiva)",                         {reg:[30], apr:[19,23]}),
  e(106, "Energ√≠as Renovables (Electiva)",                        {reg:[20,24,26,28,32], apr:[2]}),
  e(107, "Gesti√≥n del Conocimiento e Innovaci√≥n (Electiva)",      {reg:[18,27], apr:[10,25]}),
  e(108, "Coaching de Formadores (Electiva)",                     {reg:[17,18,19], apr:[10,14]}),
  e(109, "Simulaci√≥n (Electiva)",                                  {reg:[27,30,31,32], apr:[18]}),
  e(110, "An√°lisis de Datos I (Electiva)",                         {reg:[25,27], apr:[10,11,14,15,33]}),
  e(111, "Sustentabilidad y Nuevas Econom√≠as (Electiva)",         {reg:[17,18,19,30], apr:[10,14]}),
  e(112, "CNH C√°tedra IN STU (Electiva)",                         {reg:[31,32,27], apr:[10,14,17,18,19]}),
];

/* ============ Almacenamiento ============ */
const LS_STATE  = 'malla-utn-frc-state';
const LS_GRADES = 'malla-utn-frc-grades';
const LS_THEME  = 'malla-utn-frc-theme';
let state  = loadJSON(LS_STATE,  {}); // { [code]: 0|1|2|3 } (pend, en curso, reg, apr)
let grades = loadJSON(LS_GRADES, {}); // { [code]: { n:int, parciales:number[], final:number|null } }
let themePref = localStorage.getItem(LS_THEME) || 'auto';
let confettiShown = false;

function loadJSON(k, fallback){ try{ return JSON.parse(localStorage.getItem(k)) || fallback; }catch{ return fallback; } }
function saveState(){ localStorage.setItem(LS_STATE, JSON.stringify(state)); }
function saveGrades(){ localStorage.setItem(LS_GRADES, JSON.stringify(grades)); }
function saveTheme(){ localStorage.setItem(LS_THEME, themePref); }

/* ============ Tema (auto + toggle) ============ */
function applyTheme(){
  let mode = themePref;
  if(mode === 'auto'){
    mode = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }
  document.documentElement.setAttribute('data-theme', mode === 'dark' ? 'dark' : 'light');
}
applyTheme();
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ()=>{
  if(themePref==='auto') applyTheme();
});
document.getElementById('btnTheme').addEventListener('click', ()=>{
  if(themePref==='auto') themePref='dark';
  else if(themePref==='dark') themePref='light';
  else themePref='auto';
  saveTheme();
  applyTheme();
});

/* ============ Render del grid ============ */
const grid = document.getElementById('grid');
const columns = [
  { title: '1¬∫ A√±o', year:1, badge:'Anual (A)' },
  { title: '2¬∫ A√±o', year:2, badge:'Anual (A)' },
  { title: '3¬∫ A√±o', year:3, badge:'Anual (A)' },
  { title: '4¬∫ A√±o', year:4, badge:'Anual (A / 1C-2C)' },
  { title: '5¬∫ A√±o', year:5, badge:'Anual (A / 1C-2C)' },
  { title: 'Electivas', year:6, badge:'1C / 2C' },
];

function render(){
  grid.innerHTML = '';
  const tplCol = document.getElementById('tpl-col');
  const tplCard = document.getElementById('tpl-card');

  for(const col of columns){
    const node = tplCol.content.cloneNode(true);
    node.querySelector('.h-title').textContent = col.title;
    node.querySelector('.badge').textContent = col.badge;
    const list = node.querySelector('.list');

    const items = (col.year===6 ? ELECTIVES : COURSES.filter(x=>x.year===col.year));
    items.forEach(item => list.appendChild(buildCard(tplCard, item)) );

    // Averages por a√±o
    const av = computeYearAverages(col.year);
    node.querySelector('.year-averages').textContent =
      `Parciales: ${fmtAvg(av.parciales)} | Finales: ${fmtAvg(av.finales)}`;

    grid.appendChild(node);
  }

  updateTopStats();
}

function buildCard(tplCard, item){
  const el = tplCard.content.cloneNode(true).children[0];
  el.dataset.code = item.code;
  el.querySelector('.title').textContent = item.name;
  el.querySelector('.code').textContent = `#${item.code}`;
  el.querySelector('.mod').textContent = item.mod || 'A';

  applyVisualState(el, getState(item.code));
  updateBlockedAndAvailable(el, item);
  updateCardGrades(el, item.code);

  // Click de estado: ciclo 0->1->2->3->0
  el.addEventListener('click', (ev)=>{
    if(ev.target && ev.target.getAttribute('data-role') === 'notas') return;

    if(el.classList.contains('blocked')){
      toggleTip(el, true);
      return;
    }

    const current = getState(item.code);
    const next = (current + 1) % 4; // 0 Pendiente, 1 En curso, 2 Regularizada, 3 Aprobada

    // Reglas: Pendiente->En curso requiere correlativas REG cumplidas (regularizadas)
    if(current === 0 && next === 1){
      const missingReg = missingForRegular(item);
      if(missingReg.length){ return showBlocked(el, item, missingReg, []); }
    }
    // Regularizada->Aprobada requiere correlativas APR aprobadas
    if(current === 2 && next === 3){
      const missingApr = missingForApproved(item);
      if(missingApr.length){ return showBlocked(el, item, [], missingApr); }
    }

    setState(item.code, next);
    refreshAll();
  });

  el.querySelector('[data-role="notas"]').addEventListener('click', (ev)=>{
    ev.stopPropagation();
    openGradesDialog(item.code, item.name);
  });

  el.addEventListener('mouseenter', ()=>{
    if(el.classList.contains('blocked')) toggleTip(el, true);
  });
  el.addEventListener('mouseleave', ()=>toggleTip(el,false));
  el.addEventListener('blur', ()=>toggleTip(el,false));

  return el;
}

function getState(code){ return state[code] ?? 0; }
function setState(code, val){ state[code] = val; saveState(); }

function applyVisualState(card, s){
  card.classList.remove('pending','inprogress','regular','approved');
  let label = 'Pendiente';
  if(s===1){ card.classList.add('inprogress'); label = 'En curso'; }
  else if(s===2){ card.classList.add('regular'); label = 'Regularizada'; }
  else if(s===3){ card.classList.add('approved'); label = 'Aprobada'; }
  else { card.classList.add('pending'); }
  card.querySelector('.state').textContent = label;
}

function courseByCode(code){
  return COURSES.find(x=>x.code===code) || ELECTIVES.find(x=>x.code===code);
}

function missingForRegular(item){
  // Para poder cursar: correlativas REG deben estar al menos REGULARIZADAS (>=2)
  return (item.reg||[]).filter(code => getState(code) < 2);
}
function missingForApproved(item){
  // Para aprobar: correlativas APR deben estar APROBADAS (>=3)
  return (item.apr||[]).filter(code => getState(code) < 3);
}

function reasonText(item, missReg, missApr){
  const fmt = codes => codes.map(c=>`#${c} ‚Äì ${courseByCode(c)?.name||'¬ø?'} (${stateLabel(getState(c))})`).join('\n');
  const lines = [];
  if(missReg.length){ lines.push('Para CURSAR/REGULARIZAR necesitas:\n' + fmt(missReg)); }
  if(missApr.length){ lines.push('Para APROBAR necesitas:\n' + fmt(missApr)); }
  return lines.join('\n\n');
}
function stateLabel(s){ return s===3?'Aprobada':(s===2?'Regularizada':(s===1?'En curso':'Pendiente')); }

function updateBlockedAndAvailable(card, item){
  const s = getState(item.code);
  let blocked=false, tip='';
  if(s===0){ // pendiente
    const miss = missingForRegular(item);
    blocked = miss.length>0; tip = reasonText(item, miss, []);
  } else if(s===2){ // regularizada, para pasar a aprobada chequea APR
    const miss = missingForApproved(item);
    blocked = miss.length>0; tip = reasonText(item, [], miss);
  } else {
    blocked=false; tip='';
  }
  card.classList.toggle('blocked', blocked);
  const available = (s===0 && !blocked);     // disponible para cursar
  card.classList.toggle('available', available);

  const tipEl = card.querySelector('.tooltip');
  tipEl.textContent = blocked ? tip : '';
  card.title = blocked ? tip.replaceAll('\n',' \u2022 ') : '';
}

function showBlocked(card, item, missReg, missApr){
  const tipEl = card.querySelector('.tooltip');
  tipEl.textContent = reasonText(item, missReg, missApr);
  card.classList.add('blocked');
  toggleTip(card,true);
}
function toggleTip(card, show){ card.classList.toggle('show-tip', !!show); }

function updateCardGrades(card, code){
  const g = getGrades(code);
  const parcAvg = avg(g.parciales);
  const finals = (typeof g.final === 'number') ? g.final.toFixed(2) : '‚Äì';
  const line = card.querySelector('.gradesline');
  line.textContent = `Parciales: ${parcAvg==null?'‚Äì':parcAvg.toFixed(2)} | Final: ${finals}`;
}

function refreshAll(){
  document.querySelectorAll('.card').forEach(card=>{
    const code = +card.dataset.code;
    applyVisualState(card, getState(code));
    updateBlockedAndAvailable(card, courseByCode(code));
    updateCardGrades(card, code);
  });
  render(); // reconstruye encabezados con promedios por a√±o y stats
}

/* ============ Exportar / Importar / Reset ============ */
document.getElementById('btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify({ state, grades, theme: themePref }, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'malla-utn-frc-industrial-estado.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
});

document.getElementById('importFile').addEventListener('change', (ev)=>{
  const file = ev.target.files?.[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(String(reader.result));
      if(data.state)  state = data.state;
      if(data.grades) grades = data.grades;
      if(data.theme)  themePref = data.theme;
      saveState(); saveGrades(); saveTheme(); applyTheme();
      render();
    }catch(e){ alert('Archivo inv√°lido. Debe ser JSON exportado desde esta malla.'); }
  };
  reader.readAsText(file);
});

document.getElementById('btnReset').addEventListener('click', ()=>{
  if(confirm('¬øSeguro que deseas borrar todo tu progreso (estados, notas y tema)?')){
    state = {}; grades = {}; themePref='auto'; confettiShown=false;
    saveState(); saveGrades(); saveTheme(); applyTheme();
    render();
  }
});

/* ============ Notas ============ */
const dlg      = document.getElementById('dlgNotas');
const form     = document.getElementById('formNotas');
const selCant  = document.getElementById('selCantidad');
const boxParts = document.getElementById('inputsParciales');
const inpFinal = document.getElementById('inpFinal');
const prevParc = document.getElementById('prevPromParc');
const prevFinal= document.getElementById('prevPromFinal');
const dlgTitle = document.getElementById('dlgTitulo');
let currentCourseCode = null;

function openGradesDialog(code, name){
  currentCourseCode = code;
  dlgTitle.textContent = `#${code} ‚Äì ${name}`;
  const g = getGrades(code);

  selCant.value = String(g.n ?? g.parciales.length ?? 0);
  rebuildParcialInputs(+selCant.value, g.parciales || []);
  inpFinal.value = (g.final ?? '') + '';

  updatePreview();
  dlg.showModal();
}

function getGrades(code){
  const g = grades[code];
  if(!g) return { n: 0, parciales: [], final: null };
  return {
    n: Math.max(0, Math.min(6, Number.isInteger(g.n) ? g.n : (Array.isArray(g.parciales)? g.parciales.length : 0))),
    parciales: Array.isArray(g.parciales) ? g.parciales : [],
    final: (typeof g.final === 'number') ? g.final : null
  };
}

function rebuildParcialInputs(n, values=[]){
  boxParts.innerHTML = '';
  for(let i=0;i<n;i++){
    const input = document.createElement('input');
    input.type='number'; input.min='0'; input.max='10'; input.step='0.01';
    input.placeholder = `Parcial ${i+1}`;
    input.value = values[i] != null ? values[i] : '';
    input.addEventListener('input', updatePreview);
    boxParts.appendChild(input);
  }
}
selCant.addEventListener('change', ()=>{
  rebuildParcialInputs(+selCant.value, []);
  updatePreview();
});
inpFinal.addEventListener('input', updatePreview);

function parseInputsToArray(){
  return Array.from(boxParts.querySelectorAll('input'))
    .map(i=>parseFloat(i.value.replace(',', '.')))
    .filter(v=>!Number.isNaN(v));
}

function avg(arr){
  if(!arr || !arr.length) return null;
  const s = arr.reduce((a,b)=>a+b,0);
  return +(s/arr.length).toFixed(2);
}

function updatePreview(){
  const parc = parseInputsToArray();
  const fn   = parseFloat(inpFinal.value.replace(',', '.'));
  prevParc.textContent  = 'Prom. parciales: ' + (avg(parc) ?? '‚Äì');
  prevFinal.textContent = 'Prom. final(es): ' + (!Number.isNaN(fn) ? fn.toFixed(2) : '‚Äì');
}

form.addEventListener('submit', (ev)=>{
  ev.preventDefault();
  const n = +selCant.value;
  const parc = parseInputsToArray();
  const fn = parseFloat(inpFinal.value.replace(',', '.'));
  grades[currentCourseCode] = {
    n,
    parciales: parc.slice(0, n),
    final: Number.isNaN(fn) ? null : +fn.toFixed(2)
  };
  saveGrades();
  render();
  dlg.close();
});

form.addEventListener('reset', ()=>setTimeout(()=>dlg.close(), 0));

/* ============ C√°lculos de promedios y estad√≠sticas ============ */
function coursesAll(){ return [...COURSES, ...ELECTIVES]; }
function totals(){
  const all = coursesAll();
  const total = all.length;
  let reg = 0, apr = 0;
  for(const c of all){
    const s = getState(c.code);
    if(s>=2) reg++;   // regularizadas = estado >= 2
    if(s>=3) apr++;   // aprobadas = estado >= 3
  }
  return { total, reg, apr };
}
function topAverages(){
  const all = coursesAll();
  let parcVals = []; let finalVals = [];
  for(const c of all){
    const g = getGrades(c.code);
    const aParc = avg(g.parciales);
    if(aParc!=null) parcVals.push(aParc);
    if(typeof g.final === 'number') finalVals.push(g.final);
  }
  return { parciales: avg(parcVals), finales: avg(finalVals) };
}
function computeYearAverages(year){
  const items = (year===6 ? ELECTIVES : COURSES.filter(x=>x.year===year));
  let parcVals = []; let finalVals = [];
  for(const c of items){
    const g = getGrades(c.code);
    const aParc = avg(g.parciales);
    if(aParc!=null) parcVals.push(aParc);
    if(typeof g.final === 'number') finalVals.push(g.final);
  }
  return { parciales: avg(parcVals), finales: avg(finalVals) };
}

function updateTopStats(){
  const { total, reg, apr } = totals();
  const pct = (n)=> total? Math.round((n/total)*100) : 0;
  document.getElementById('pillReg').textContent  = `Regularizadas: ${reg} (${pct(reg)}%)`;
  document.getElementById('pillApr').textContent  = `Aprobadas: ${apr} (${pct(apr)}%)`;

  const av = topAverages();
  document.getElementById('pillPromParc').textContent  = 'Promedio Parciales: ' + (fmtAvg(av.parciales));
  document.getElementById('pillPromFinal').textContent = 'Promedio Finales: '   + (fmtAvg(av.finales));

  // Confetti si est√° todo aprobado
  if(apr === total && total>0 && !confettiShown){
    confettiShown = true;
    launchConfetti();
  } else if (apr !== total){
    confettiShown = false; // por si import√°s un estado nuevo
  }
}

function fmtAvg(x){ return (x==null ? '‚Äì' : x.toFixed(2)); }

/* ============ Confetti sin librer√≠as ============ */
function launchConfetti(){
  const canvas = document.getElementById('confettiCanvas');
  const ctx = canvas.getContext('2d');
  let W = canvas.width = window.innerWidth;
  let H = canvas.height = window.innerHeight;
  const colors = ['#f87171','#fbbf24','#34d399','#60a5fa','#a78bfa','#f472b6'];
  const pieces = Array.from({length: 240}).map(()=> ({
    x: Math.random()*W,
    y: -20 - Math.random()*H,
    w: 6+Math.random()*6,
    h: 8+Math.random()*10,
    col: colors[Math.floor(Math.random()*colors.length)],
    vy: 2 + Math.random()*3,
    vx: -1 + Math.random()*2,
    rot: Math.random()*Math.PI,
    vr: -0.1 + Math.random()*0.2
  }));
  let running = true;
  const endAt = performance.now() + 3800;

  function draw(){
    if(!running) return;
    if(performance.now() > endAt) running=false;
    ctx.clearRect(0,0,W,H);
    for(const p of pieces){
      p.x += p.vx; p.y += p.vy; p.rot += p.vr;
      if(p.y > H+20) p.y = -10;
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.col;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
    }
    if(running) requestAnimationFrame(draw);
    else ctx.clearRect(0,0,W,H);
  }
  window.addEventListener('resize', ()=>{
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
  });
  draw();
}

/* ============ Inicializar ============ */
render();
</script>
</body>
</html>